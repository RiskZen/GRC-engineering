import streamlit as st
import pandas as pd
from sentence_transformers import SentenceTransformer, util
import torch
import google.generativeai as genai
import json
import sqlite3
import datetime
import plotly.express as px

# --- 1. CONFIG & DB SETUP ---
st.set_page_config(
    page_title="UCF Enterprise Platform",
    page_icon="üõ°Ô∏è",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Initialize SQLite Database
conn = sqlite3.connect('grc_saas_v2.db', check_same_thread=False)
c = conn.cursor()

# Schema
c.execute('''CREATE TABLE IF NOT EXISTS mappings 
             (control_id TEXT PRIMARY KEY, control_text TEXT, policy_text TEXT, ai_plan TEXT, 
              automation_script TEXT, 
              status TEXT, last_result TEXT, last_updated TEXT, exception_reason TEXT)''')

c.execute('''CREATE TABLE IF NOT EXISTS audit_logs 
             (timestamp TEXT, control_id TEXT, evidence_source TEXT, result TEXT, reason TEXT)''')
conn.commit()

# --- 2. CSS STYLING ---
st.markdown("""
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    
    html, body, [class*="css"] { font-family: 'Inter', sans-serif; color: #0f172a; }
    .stApp { background-color: #f8fafc; }
    
    /* SIDEBAR */
    section[data-testid="stSidebar"] { background-color: #020617; border-right: 1px solid #1e293b; }
    section[data-testid="stSidebar"] * { color: #94a3b8 !important; font-weight: 500; }
    
    /* LOGO & MENU */
    .sidebar-logo { color: white !important; font-size: 1.5rem; font-weight: 700; margin-bottom: 2rem; display: flex; align-items: center; gap: 10px; }
    .menu-header { color: #94a3b8; font-size: 13px; font-weight: 600; margin-top: 30px; margin-bottom: 10px; padding-left: 10px; }
    
    div[data-testid="stRadio"] label { background-color: transparent; padding: 12px 10px; border-radius: 6px; transition: all 0.2s; margin-bottom: 2px; color: #94a3b8 !important; font-weight: 500; font-size: 15px; cursor: pointer; display: flex; align-items: center; }
    div[data-testid="stRadio"] label:hover { color: #ffffff !important; background-color: rgba(255, 255, 255, 0.05); }
    div[data-testid="stRadio"] label[data-checked="true"] { color: #ffffff !important; font-weight: 600; background-color: transparent; }
    div[data-testid="stRadio"] div[role="radiogroup"] > label > div:first-child { display: none; }

    /* CARDS */
    .main-card { background-color: white; border-radius: 12px; padding: 25px; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05); border: 1px solid #e2e8f0; margin-bottom: 20px; }
    .metric-card { background-color: white; border-radius: 12px; padding: 25px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; height: 140px; display: flex; flex-direction: column; justify-content: center; }
    .metric-value { font-size: 2.5rem; font-weight: 700; color: #0f172a; margin: 0; }
    .metric-label { font-size: 0.8rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-top: 5px; }
    
    /* BADGES */
    .pass-badge { color: #166534; background: #dcfce7; padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 12px; }
    .fail-badge { color: #991b1b; background: #fee2e2; padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 12px; }
    .exception-box { border-left: 5px solid #eab308; background-color: #fffbeb; padding: 15px; border-radius: 6px; }

    /* BUTTONS */
    .stButton>button { background-color: #2563eb; color: white; border-radius: 6px; border: none; font-weight: 600; padding: 0.5rem 1rem; }
    .stButton>button:hover { background-color: #1d4ed8; }
</style>
""", unsafe_allow_html=True)

# --- 3. BACKEND FUNCTIONS ---
@st.cache_resource
def load_embedding_model():
    return SentenceTransformer('all-MiniLM-L6-v2')

def call_gemini(prompt):
    try:
        if "GOOGLE_API_KEY" in st.secrets:
            genai.configure(api_key=st.secrets["GOOGLE_API_KEY"])
            models = ['gemini-flash-latest', 'gemini-1.5-flash', 'gemini-pro']
            for m in models:
                try:
                    model = genai.GenerativeModel(m)
                    return model.generate_content(prompt).text
                except: continue
            return "‚ùå Error: API unavailable."
        return "Error: API Key missing."
    except Exception as e: return f"Error: {e}"

def db_save_mapping(cid, ctext, ptext, plan, script):
    c.execute("INSERT OR REPLACE INTO mappings VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)",
              (cid, ctext, ptext, plan, script, 'Untested', None, None, None))
    conn.commit()

def db_update_audit(cid, status, result_text, filename):
    ts = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    c.execute("UPDATE mappings SET status = ?, last_result = ?, last_updated = ?, exception_reason = NULL WHERE control_id = ?",
              (status, result_text, ts, cid))
    c.execute("INSERT INTO audit_logs VALUES (?, ?, ?, ?, ?)", (ts, cid, filename, status, result_text))
    conn.commit()

def db_grant_exception(cid, justification):
    ts = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    c.execute("UPDATE mappings SET status = 'EXCEPTION', last_updated = ?, exception_reason = ? WHERE control_id = ?",
              (ts, justification, cid))
    c.execute("INSERT INTO audit_logs VALUES (?, ?, ?, ?, ?)", (ts, cid, "Manual Override", "EXCEPTION", justification))
    conn.commit()

def db_get_mappings():
    return pd.read_sql("SELECT * FROM mappings", conn)

def db_get_control(cid):
    c.execute("SELECT * FROM mappings WHERE control_id = ?", (cid,))
    return c.fetchone()

def db_get_history(cid):
    return pd.read_sql("SELECT timestamp, evidence_source, result, reason FROM audit_logs WHERE control_id = ? ORDER BY timestamp DESC", conn, params=(cid,))

# --- 4. PAGE: DATA INGESTION ---
def render_ingestion():
    st.markdown('<div style="color:#64748b; margin-bottom:5px;">Workspace / Data Ingestion</div>', unsafe_allow_html=True)
    st.title("Data Ingestion")
    
    if 'p_df' not in st.session_state: st.session_state['p_df'] = None
    if 'u_df' not in st.session_state: st.session_state['u_df'] = None

    st.markdown('<div class="main-card">', unsafe_allow_html=True)
    c1, c2 = st.columns(2)
    with c1:
        st.subheader("1. Internal Policies")
        f1 = st.file_uploader("Upload CSV", key="p", type=["csv"])
        if f1: 
            try:
                st.session_state['p_df'] = pd.read_csv(f1, engine='python', on_bad_lines='warn')
                st.success(f"Ready: {len(st.session_state['p_df'])} policies")
            except Exception as e: st.error(f"CSV Error: {e}")
    
    with c2:
        st.subheader("2. Regulatory Controls")
        f2 = st.file_uploader("Upload CSV", key="u", type=["csv"])
        if f2: 
            try:
                st.session_state['u_df'] = pd.read_csv(f2, engine='python', on_bad_lines='warn')
                st.success(f"Ready: {len(st.session_state['u_df'])} controls")
            except Exception as e: st.error(f"CSV Error: {e}")
    st.markdown('</div>', unsafe_allow_html=True)

    st.markdown("### üöÄ AI Core")
    if st.button("Run AI Semantic Mapping & Code Gen", use_container_width=True):
        if st.session_state['p_df'] is None or st.session_state['u_df'] is None:
            st.error("Please upload both CSV files first.")
            return
            
        with st.status("üß† Engineering AI Agents Working...", expanded=True):
            st.write("Vectorizing Data...")
            embedder = load_embedding_model()
            p_df, u_df = st.session_state['p_df'], st.session_state['u_df']
            
            p_emb = embedder.encode(p_df['Policy_Text'].head(5).astype(str).tolist(), convert_to_tensor=True)
            u_emb = embedder.encode(u_df['Control_Text'].head(5).astype(str).tolist(), convert_to_tensor=True)
            
            st.write("Generating Detection Scripts...")
            bar = st.progress(0)
            
            for i in range(len(p_df.head(5))):
                bar.progress((i+1)/5)
                scores = util.cos_sim(p_emb[i], u_emb)[0]
                best_idx = torch.topk(scores, k=1)[1][0].item()
                ctrl = u_df.iloc[best_idx]
                
                plan = call_gemini(f"Role: Auditor. Control: {ctrl['Control_Text']}. Policy: {p_df.iloc[i]['Policy_Text']}. Task: Write concise test procedure.")
                script = call_gemini(f"Role: DevOps. Write a Python Boto3 script to check: {ctrl['Control_Text']}. Return ONLY code.")
                
                db_save_mapping(ctrl['Control_ID'], ctrl['Control_Text'], p_df.iloc[i]['Policy_Text'], plan, script)
            
            st.success("Mapping Complete!")

# --- 5. PAGE: CONTROL MAPPING (Improved Table) ---
def render_mapping_view():
    st.markdown('<div style="color:#64748b; margin-bottom:5px;">Workspace / Control Mapping</div>', unsafe_allow_html=True)
    st.title("Control Mapping View")
    
    df = db_get_mappings()
    if df.empty: st.warning("‚ö†Ô∏è No mappings found. Please go to **Data Ingestion** first."); return

    st.markdown('<div class="main-card">', unsafe_allow_html=True)
    st.subheader(f"Mapped Relationships ({len(df)} Controls)")
    st.write("Alignment between Regulatory Framework and Internal Policy:")
    
    # Configure Columns for better readability (wrapping text)
    st.dataframe(
        df[['control_id', 'control_text', 'policy_text']], 
        use_container_width=True, 
        hide_index=True,
        column_config={
            "control_id": st.column_config.TextColumn("ID", width="small"),
            "control_text": st.column_config.TextColumn("Regulatory Control", width="medium"),
            "policy_text": st.column_config.TextColumn("Mapped Internal Policy", width="medium")
        }
    )
    st.markdown('</div>', unsafe_allow_html=True)

# --- 6. PAGE: ENGINEERING HUB ---
def render_engineering_hub():
    st.markdown('<div style="color:#64748b; margin-bottom:5px;">Workspace / Engineering Hub</div>', unsafe_allow_html=True)
    st.title("GRC Engineering Hub")
    
    df = db_get_mappings()
    if df.empty: st.info("No mappings found."); return

    st.markdown("Compliance-as-Code Artifacts:")
    st.write("")

    for i, row in df.iterrows():
        status_icon = "üü¢" if row['status'] == 'PASS' else "üî¥" if row['status'] == 'FAIL' else "üü°" if row['status'] == 'EXCEPTION' else "‚ö™"
        with st.expander(f"{status_icon} {row['control_id']} | {row['control_text'][:60]}..."):
            t1, t2 = st.tabs(["üìÑ Audit Plan", "üêç Automation (Python)"])
            with t1: st.info(row['ai_plan'])
            with t2: st.code(row['automation_script'], language='python')

# --- 7. PAGE: AUDIT AGENTS (Improved Selection) ---
def render_agents():
    st.markdown('<div style="color:#64748b; margin-bottom:5px;">Workspace / Audit Agents</div>', unsafe_allow_html=True)
    st.title("Audit Agents")
    
    df = db_get_mappings()
    if df.empty: st.warning("Please map controls first."); return
    
    st.markdown('<div class="main-card">', unsafe_allow_html=True)
    c1, c2 = st.columns([1, 2])
    
    with c1:
        # --- MODIFICATION: Dropdown shows ID + Text ---
        # Create list of strings: "ID | Text..."
        options = [f"{row['control_id']} | {row['control_text'][:50]}..." for idx, row in df.iterrows()]
        selected_option = st.selectbox("Select Control to Audit", options)
        
        # Extract ID from selection
        selected_id = selected_option.split(" | ")[0]
        
        # Fetch fresh data
        record = db_get_control(selected_id) 
        # tuple index: 0:id, 1:text, 2:poly, 3:plan, 4:script, 5:status, 6:res, 7:upd, 8:exc
        
        st.info(f"**Requirement:** {record[1]}")

    with c2:
        st.subheader("üì° Evidence Connector")
        f = st.file_uploader("Upload Wiz/AWS JSON", type=['json'], key=f"up_{selected_id}")
        
        if f:
            evidence = json.load(f)
            if st.button("Run AI Audit"):
                with st.spinner("Analyzing..."):
                    prompt = f"Role: Auditor. Control: {record[1]}. Evidence: {json.dumps(evidence)}. Output: 'PASS' or 'FAIL' followed by 1 sentence reason."
                    res = call_gemini(prompt)
                    status = "PASS" if "PASS" in res.upper() else "FAIL"
                    db_update_audit(selected_id, status, res, f.name)
                    st.rerun()
    
    if record[5] != 'Untested': 
        if record[5] == 'PASS':
            st.markdown(f"""<div style="margin-top:20px; padding:15px; border:1px solid #bbf7d0; background:#f0fdf4; border-radius:8px;">
                <span class="pass-badge">PASS</span> <span style="margin-left:10px;">{record[6]}</span>
            </div>""", unsafe_allow_html=True)
        elif record[5] == 'EXCEPTION':
            st.markdown(f"""<div class="exception-box" style="margin-top:20px;"><strong>üü° EXCEPTION GRANTED</strong><br>Reason: {record[8]}</div>""", unsafe_allow_html=True)
        elif record[5] == 'FAIL':
            st.markdown(f"""<div style="margin-top:20px; padding:15px; border:1px solid #fecaca; background:#fef2f2; border-radius:8px;">
                <span class="fail-badge">FAIL</span> <span style="margin-left:10px;">{record[6]}</span>
            </div>""", unsafe_allow_html=True)
            
            st.write("---")
            col_fix, col_exc = st.columns(2)
            with col_fix:
                st.subheader("üõ†Ô∏è Remediation")
                if st.button("Generate Fix Code"):
                    with st.spinner("Generating IaC Fix..."):
                        fix_code = call_gemini(f"Role: DevOps. Context: Control '{record[1]}' FAILED. Error: {record[6]}. Write CLI/Terraform to fix. Return ONLY code.")
                        st.code(fix_code, language='bash')
            with col_exc:
                st.subheader("‚ö†Ô∏è Exception")
                with st.expander("Grant Exception"):
                    justification = st.text_area("Justification")
                    if st.button("Approve"):
                        if justification:
                            db_grant_exception(selected_id, justification)
                            st.success("Granted.")
                            st.rerun()

    st.markdown('</div>', unsafe_allow_html=True)
    st.markdown(f"### üìú Audit History")
    history = db_get_history(selected_id)
    if not history.empty: st.dataframe(history, use_container_width=True)

# --- 8. PAGE: DASHBOARD ---
def render_dashboard():
    st.markdown('<div class="breadcrumb">Workspace / Dashboard</div>', unsafe_allow_html=True)
    st.markdown('<h1 style="color:#0f172a; font-weight:800; margin-bottom:20px;">Executive Dashboard</h1>', unsafe_allow_html=True)
    
    df = db_get_mappings()
    if df.empty: st.info("No data available. Please go to Data Ingestion."); return

    total = len(df)
    passed = len(df[df['status'] == 'PASS'])
    failed = len(df[df['status'] == 'FAIL'])
    exceptions = len(df[df['status'] == 'EXCEPTION'])
    untested = len(df[df['status'] == 'Untested'])
    score_denominator = total - untested
    score = int(((passed + exceptions) / score_denominator) * 100) if score_denominator > 0 else 0

    c1, c2, c3, c4 = st.columns(4)
    def metric_html(val, lbl, color="#0f172a"):
        return f"""<div class="metric-card"><h1 class="metric-value" style="color: {color}">{val}</h1><p class="metric-label">{lbl}</p></div>"""

    c1.markdown(metric_html(f"{score}%", "COMPLIANCE SCORE"), unsafe_allow_html=True)
    c2.markdown(metric_html(passed, "PASSING", "#22c55e"), unsafe_allow_html=True)
    c3.markdown(metric_html(failed, "FAILING", "#ef4444"), unsafe_allow_html=True)
    c4.markdown(metric_html(exceptions, "EXCEPTIONS", "#eab308"), unsafe_allow_html=True)

    st.write("")
    col1, col2 = st.columns(2)
    with col1:
        st.markdown("### Control Status")
        st.markdown('<div class="main-card">', unsafe_allow_html=True)
        chart_data = pd.DataFrame({'Status': ['Passing', 'Failing', 'Exception', 'Untested'], 'Count': [passed, failed, exceptions, untested]})
        fig = px.pie(chart_data, values='Count', names='Status', hole=0.5, 
                     color='Status', 
                     color_discrete_map={'Passing':'#22c55e', 'Failing':'#ef4444', 'Exception':'#eab308', 'Untested':'#cbd5e1'})
        fig.update_layout(margin=dict(t=0, b=0, l=0, r=0), height=250)
        st.plotly_chart(fig, use_container_width=True)
        st.markdown('</div>', unsafe_allow_html=True)

    with col2:
        st.markdown("### Risk by Domain")
        st.markdown('<div class="main-card">', unsafe_allow_html=True)
        domain_data = pd.DataFrame({"Domain": ["Access", "Encryption", "Logging", "Network"], "Risk": [10, 80, 20, 40]})
        fig2 = px.bar(domain_data, x="Domain", y="Risk", color="Risk", color_continuous_scale="Reds")
        fig2.update_layout(margin=dict(t=0, b=0, l=0, r=0), height=250, showlegend=False)
        st.plotly_chart(fig2, use_container_width=True)
        st.markdown('</div>', unsafe_allow_html=True)

# --- 9. SIDEBAR NAVIGATION ---
with st.sidebar:
    st.markdown("""
    <div class="logo-container">
        <div class="logo-box">U</div>
        <div class="logo-text">UCF Platform</div>
    </div>
    <div class="menu-header">Menu</div>
    """, unsafe_allow_html=True)
    
    page = st.radio("Nav", ["Dashboard", "Data Ingestion", "Control Mapping", "Engineering Hub", "Audit Agents"], label_visibility="collapsed")
    
    st.write("---")
    st.caption("v4.6 (Visual Upgrade)")
    if st.button("Reset DB"):
        c.execute("DELETE FROM mappings"); c.execute("DELETE FROM audit_logs"); conn.commit()
        st.rerun()

# --- 10. ROUTING ---
if page == "Dashboard": render_dashboard()
elif page == "Data Ingestion": render_ingestion()
elif page == "Control Mapping": render_mapping_view()
elif page == "Engineering Hub": render_engineering_hub()
elif page == "Audit Agents": render_agents()
